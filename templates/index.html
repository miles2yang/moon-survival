<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>æœˆçƒå€–å­˜ + Generative AI å°è©±</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.14.0/Sortable.min.js"></script>
</head>
<body>
  <div class="container">
    <h1>ğŸŒ™ æœˆçƒå€–å­˜å¯¦é©— + Generative AI å°è©±</h1>
    <p class="muted">å·¦å´æ‹–æ”¾æ’åºä¸¦è©•åˆ†ï¼›å³å´å¯èˆ‡ AI è¨è«–ç­–ç•¥æˆ–è©¢å•å»ºè­°ã€‚</p>

    <div class="two-col">
      <!-- LEFT: Moon Survival Task -->
      <div class="left-panel panel">
        <h2>Moon Survival Task</h2>
        <p class="muted">æŠŠç‰©å“å¾æœ€é‡è¦æ‹–åˆ°æœ€ä¸é‡è¦ï¼ˆæœ€ä¸Šé¢ = æœ€é‡è¦ï¼‰ã€‚</p>
        <ul id="items" class="item-list">
          {% for it in items %}
          <li class="item" data-name="{{ it.name }}">
            <strong class="item-title">{{ it.name }}</strong>
            <div class="item-desc">{{ it.description }}</div>
          </li>
          {% endfor %}
        </ul>
        <div class="controls">
          <button id="evaluateBtn">è©•åˆ†</button>
          <button id="resetBtn">å›å¾©é è¨­</button>
        </div>

        <div id="taskResult" class="task-result"></div>
      </div>

      <!-- RIGHT: Generative AI Chat -->
      <div class="right-panel panel chat-panel">
        <h2>Generative AI å°è©±</h2>
        <div id="chatWindow" class="chat-window">
          <div id="messages" class="messages">
            <div class="msg system">ä½ å¯ä»¥è©¢å•ï¼šä¾‹å¦‚ã€Œæ°§æ°£é‡è¦å—ï¼Ÿã€æˆ–ã€Œå¦‚ä½•åœ¨æœˆçƒä¸Šä¿æŒæ°´æºï¼Ÿã€</div>
          </div>
        </div>

        <form id="chatForm" class="chat-form" onsubmit="return false;">
          <input id="chatInput" type="text" placeholder="è¼¸å…¥è¨Šæ¯ä¸¦æŒ‰é€å‡º..." autocomplete="off" />
          <button id="sendBtn" type="button">é€å‡º</button>
        </form>

        <div class="ai-hint">
          {% if openai_enabled %}
            <small>OpenAI å·²å•Ÿç”¨ï¼ˆå¾Œç«¯æœƒä½¿ç”¨ OpenAI å›æ‡‰ï¼‰ã€‚</small>
          {% else %}
            <small>OpenAI æœªè¨­å®šï¼šç›®å‰ä½¿ç”¨æœ¬åœ°ç°¡æ˜“å›æ‡‰ã€‚è¨­å®š OPENAI_API_KEY å¯å•Ÿç”¨çœŸå¯¦ AIã€‚</small>
          {% endif %}
        </div>
      </div>
    </div>

    <footer>
      <small class="muted">åœ¨ Codespaces å•Ÿå‹•å¾Œè½‰ç™¼ 5000 portï¼Œæˆ–æœ¬æ©Ÿç€è¦½ <code>http://127.0.0.1:5000</code></small>
    </footer>
  </div>

  <script>
    // Sortable for task list
    const el = document.getElementById('items');
    Sortable.create(el, { animation: 150 });

    function getOrder() {
      return Array.from(document.querySelectorAll('#items .item'))
        .map(li => li.dataset.name);
    }

    function showTaskResult(json) {
      const div = document.getElementById('taskResult');
      div.innerHTML = `<p><strong>åˆ†æ•¸ï¼š</strong> ${json.score}ï¼ˆè¶Šä½è¶Šå¥½ï¼‰</p>`;

      let html = '<table class="result-table"><thead><tr><th>#</th><th>ç‰©å“</th><th>ä½ çš„é †ä½</th><th>å®˜æ–¹é †ä½</th><th>å·®è·</th></tr></thead><tbody>';
      json.per_item.forEach((row, idx) => {
        const diff = row.diff === null ? '-' : row.diff;
        html += `<tr>
          <td>${idx + 1}</td>
          <td>${row.name}</td>
          <td>${row.submitted_rank}</td>
          <td>${row.official_rank ?? '-'};</td>
          <td>${diff}</td>
        </tr>`;
      });
      html += '</tbody></table>';
      div.innerHTML += html;
      div.scrollIntoView({ behavior: 'smooth' });
    }

    document.getElementById('evaluateBtn').addEventListener('click', async () => {
      const order = getOrder();
      const resp = await fetch('/evaluate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ order })
      });
      if (!resp.ok) {
        alert('è©•åˆ†å¤±æ•—ï¼Œè«‹é‡è©¦');
        return;
      }
      const json = await resp.json();
      showTaskResult(json);
    });

    document.getElementById('resetBtn').addEventListener('click', () => {
      location.reload();
    });

    // Chat UI logic
    const messagesEl = document.getElementById('messages');
    function appendMessage(role, text) {
      const div = document.createElement('div');
      div.className = 'msg ' + role;
      div.textContent = text;
      messagesEl.appendChild(div);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    async function sendChat(message) {
      appendMessage('user', message);
      appendMessage('thinking', 'AI å›æ‡‰ä¸­â€¦');

      try {
        const resp = await fetch('/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message })
        });
        const data = await resp.json();
        // remove the "thinking" bubble
        const thinking = document.querySelector('.msg.thinking');
        if (thinking) thinking.remove();

        if (resp.ok && data.reply) {
          appendMessage('assistant', data.reply);
        } else {
          appendMessage('assistant', 'å›æ‡‰å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
        }
      } catch (err) {
        const thinking = document.querySelector('.msg.thinking');
        if (thinking) thinking.remove();
        appendMessage('assistant', 'é€šè¨ŠéŒ¯èª¤ï¼š' + err.message);
      }
    }

    document.getElementById('sendBtn').addEventListener('click', () => {
      const input = document.getElementById('chatInput');
      const text = input.value.trim();
      if (!text) return;
      input.value = '';
      sendChat(text);
    });

    // Enter to send
    document.getElementById('chatInput').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        document.getElementById('sendBtn').click();
      }
    });
  </script>
</body>
</html>
